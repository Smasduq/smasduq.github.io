<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smasduq - The Number Guesser (Bulls & Cows)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* Custom Font Setup */
        body { font-family: 'Inter', sans-serif; }

        /* General style improvements */
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        /* Specific styles for the four digit inputs */
        .digit-input {
            width: 4rem; /* Fixed width for desktop/tablet */
            height: 4rem;
            text-align: center;
            font-size: 2.5rem;
            border-radius: 0.75rem;
            border: 2px solid #a78bfa; /* Default purple border */
            transition: all 0.2s;
            background-color: #fff; /* White background */
            color: #1f2937; /* Dark text */
            font-weight: 700;
        }

        /* --- CSS to REMOVE the spinner arrows (modern look) --- */
        /* Since we changed to type="text", this might be less necessary, but good practice to keep the number-specific overrides */
        .digit-input::-webkit-outer-spin-button,
        .digit-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        .digit-input[type=number] {
            -moz-appearance: textfield;
            -webkit-appearance: none; 
            appearance: none; /* Standard property */
            margin: 0;
        }
        /* -------------------------------------------------------- */
        
        /* Dark mode overrides for inputs */
        .dark .digit-input {
            background-color: #374151; /* Gray-700 */
            color: #f3f4f6; /* Light text */
            border-color: #4b5563; /* Gray-600 */
        }

        /* Focus state for inputs (Green ring/border) */
        .digit-input:focus {
            outline: none;
            border-color: #10b981; /* emerald-500 */
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.5);
        }

        /* Submit Button Styling */
        .submit-button {
            background-color: #4f46e5; /* indigo-600 */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .submit-button:hover:not(:disabled) {
            background-color: #4338ca; /* indigo-700 */
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .submit-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 60;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal-content {
            transform: scale(1);
        }

        /* Light-mode fallbacks when html is not .dark (pragmatic) */
        html:not(.dark) .bg-white { background-color: #ffffff !important; }
        html:not(.dark) .bg-gray-50 { background-color: #f9fafb !important; }
        html:not(.dark) .bg-gray-100 { background-color: #f3f4f6 !important; }
        html:not(.dark) .bg-indigo-50 { background-color: #eef2ff !important; }
        html:not(.dark) .bg-indigo-100 { background-color: #e0e7ff !important; }
        html:not(.dark) .bg-green-50 { background-color: #f0fdf4 !important; }
        html:not(.dark) .bg-green-100 { background-color: #dcfce7 !important; }
        html:not(.dark) .bg-red-100 { background-color: #fee2e2 !important; }
        html:not(.dark) .bg-yellow-100 { background-color: #fef3c7 !important; }
        html:not(.dark) .bg-purple-100 { background-color: #f3e8ff !important; }

        html:not(.dark) .text-gray-900 { color: #0f172a !important; }
        html:not(.dark) .text-gray-800 { color: #1f2937 !important; }
        html:not(.dark) .text-gray-700 { color: #374151 !important; }
        html:not(.dark) .text-gray-600 { color: #4b5563 !important; }
        html:not(.dark) .text-gray-500 { color: #6b7280 !important; }
        html:not(.dark) .text-gray-400 { color: #9ca3af !important; }

        /* Buttons/CTAs fallbacks */
        html:not(.dark) .dark\:bg-indigo-500, html:not(.dark) .bg-indigo-600 { background-color: #4f46e5 !important; }
        html:not(.dark) .dark\:bg-indigo-600, html:not(.dark) .bg-indigo-500 { background-color: #6366f1 !important; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 min-h-screen flex flex-col transition-colors duration-300">

    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-xl border-b border-gray-100 dark:border-gray-700">
        <nav class="container mx-auto px-6 py-4">
            <a href="games.html" onclick="window.history.back()" title="Back to Game Zone" class="text-indigo-600 dark:text-indigo-400 p-2 rounded-full transition duration-300 
                hover:text-indigo-500 dark:hover:text-indigo-300 
                hover:bg-indigo-100/20 dark:hover:bg-indigo-900/40 
                transform hover:scale-110 
                inline-flex items-center shadow-lg hover:shadow-xl">
                
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1.5">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7">
                    <rect x="2" y="4" width="20" height="16" rx="3" ry="3"></rect>
                    <line x1="6" y1="10" x2="6" y2="14"></line>
                    <line x1="8" y1="12" x2="4" y2="12"></line>
                    <line x1="18" y1="10" x2="18" y2="14"></line>
                    <line x1="20" y1="12" x2="16" y2="12"></line>
                    <line x1="10" y1="16" x2="14" y2="16"></line>
                    <line x1="12" y1="18" x2="12" y2="14"></line>
                </svg>
                <span class="sr-only">Back to Game Zone</span>
            </a>
        </nav>
    </header>

    <!-- Main Game Area -->
    <main class="container mx-auto px-6 py-10 flex-grow">
        <div class="max-w-xl mx-auto text-center">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-900 dark:text-gray-100 mb-4">The Number Guesser</h1>
            <p class="text-lg text-gray-600 dark:text-gray-400 mb-6 max-w-md mx-auto">
                Guess the secret 4-digit number where all digits are unique. You have 10 guesses!
            </p>
            
            <!-- Statistics Display -->
            <div id="stats-display" class="mb-8 flex justify-center space-x-6 text-xl bg-gray-100 dark:bg-gray-700 p-4 rounded-xl font-mono shadow-inner">
                <span class="text-gray-500 dark:text-gray-400">Loading Stats...</span>
            </div>

            <div id="game-area" class="card bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl border-t-4 border-indigo-500 transition-colors duration-300">
                
                <!-- Guess Input (4 individual boxes) -->
                <div class="mb-6 flex justify-center space-x-3" id="guess-input-container">
                    <!-- CHANGED type="number" to type="text" for more reliable value reading -->
                    <input type="text" min="0" max="9" maxlength="1" class="digit-input" placeholder="0" autofocus data-index="0" inputmode="numeric">
                    <input type="text" min="0" max="9" maxlength="1" class="digit-input" placeholder="0" data-index="1" inputmode="numeric">
                    <input type="text" min="0" max="9" maxlength="1" class="digit-input" placeholder="0" data-index="2" inputmode="numeric">
                    <input type="text" min="0" max="9" maxlength="1" class="digit-input" placeholder="0" data-index="3" inputmode="numeric">
                </div>
                
                <button id="guess-button" class="w-full submit-button text-white py-3 rounded-xl font-bold text-lg transition duration-200">
                    Guess (<span id="attempts-count">10</span> left)
                </button>
                
                <p id="message" class="text-xl font-medium text-gray-700 dark:text-gray-300 mt-6 transition-colors duration-300">Start guessing! (Guess 1 of 10)</p>
                
                <!-- Previous Guesses History -->
                <div class="mt-8 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Guess History</h3>
                    <ul id="history-list" class="space-y-3 text-left max-h-60 overflow-y-auto">
                        <!-- Guesses will be inserted here -->
                    </ul>
                </div>

            </div>
        </div>
    </main>

    <!-- Game Result Modal Overlay (Win/Loss) -->
    <div id="result-modal" class="modal-overlay hidden" aria-modal="true" role="dialog">
        <div class="modal-content bg-white dark:bg-gray-900 p-8 sm:p-10 rounded-2xl shadow-2xl max-w-sm w-full text-center border-t-8 border-indigo-500 transition-colors duration-300">
            <h2 id="modal-title" class="text-4xl font-extrabold mb-4"></h2>
            <p id="modal-message" class="text-xl text-gray-700 dark:text-gray-300 mb-6"></p>
            <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-xl mb-8">
                <p class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase">The Secret Code Was:</p>
                <p id="modal-code" class="5xl font-black text-indigo-600 dark:text-indigo-400 mt-1 font-mono text-4xl"></p>
            </div>
            <button id="modal-restart-button" class="w-full bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 text-white font-bold py-3 rounded-xl text-lg transition duration-200 shadow-md">
                Play Another Round!
            </button>
        </div>
    </div>

    <!-- Error/Validation Modal Overlay (Used for both incomplete and non-unique digits) -->
    <div id="error-modal" class="modal-overlay hidden" aria-modal="true" role="dialog">
        <div class="modal-content bg-white dark:bg-gray-900 p-6 sm:p-8 rounded-2xl shadow-2xl max-w-xs w-full text-center border-t-4 border-red-500 transition-colors duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-red-500 mx-auto mb-3" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
            </svg>
            <h3 class="text-2xl font-extrabold text-red-600 mb-2">Invalid Input!</h3>
            <p id="error-modal-message" class="text-sm text-gray-700 dark:text-gray-300 mb-4 font-medium">Please enter a valid guess.</p>
            <button onclick="hideErrorModal()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded-xl text-base transition duration-200">
                Got It
            </button>
        </div>
    </div>


    <!-- Footer -->
    <footer class="bg-gray-100 dark:bg-gray-950 py-10 transition-colors duration-300">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-400 dark:text-gray-500">
            <p class="mb-4 text-sm sm:text-lg">&copy; 2025 Smasduq. All rights reserved. Enjoy the games!</p>
            <div class="mt-4 space-x-4 sm:space-x-6 text-lg sm:text-xl">
                <a href="https://www.linkedin.com/in/smasduq" target="_blank" class="hover:text-indigo-400 transition duration-300">LinkedIn</a>
                <a href="https://github.com/Smasduq" target="_blank" class="hover:text-indigo-400 transition duration-300">GitHub</a>
            </div>
        </div>
    </footer>

    <!-- Script Block -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables provided by Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let statsRef = null;
        let currentStats = { wins: 0, losses: 0 };

        // --- Firebase/Storage Logic ---

        const attemptsCountEl = document.getElementById('attempts-count');

        function updateStatsUI() {
            const statsDisplay = document.getElementById('stats-display');
            if (statsDisplay) {
                statsDisplay.innerHTML = `
                    <span class="text-green-500 font-bold">Wins: ${currentStats.wins}</span>
                    <span class="text-red-500 font-bold">Losses: ${currentStats.losses}</span>
                `;
            }
        }

        async function updateWinLossCount(isWin) {
            if (!statsRef) {
                console.warn("Stats reference not initialized. Skipping persistent save.");
                return;
            }

            const field = isWin ? 'wins' : 'losses';
            
            try {
                // Fetch current state to safely increment (although onSnapshot also updates currentStats)
                const docSnap = await getDoc(statsRef);
                let data = docSnap.exists() ? docSnap.data() : { wins: 0, losses: 0 };
                
                data[field] = (data[field] || 0) + 1;

                // Set the new data, the onSnapshot listener will update the UI
                await setDoc(statsRef, data);
            } catch (e) {
                console.error("Error updating score:", e);
            }
        }

        function setupStatsListener(userId) {
            if (!db || !userId) return;
            // Path: /artifacts/{appId}/users/{userId}/game_stats/bulls_cows
            statsRef = doc(db, 'artifacts', appId, 'users', userId, 'game_stats', 'bulls_cows');

            onSnapshot(statsRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentStats = docSnap.data();
                } else {
                    // Initialize the document if it doesn't exist
                    currentStats = { wins: 0, losses: 0 };
                    // Attempt to create the document only if it does not exist
                    setDoc(statsRef, currentStats, { merge: true }).catch(console.error);
                }
                updateStatsUI();
            }, (error) => {
                console.error("Error listening to stats:", error);
            });
        }

        async function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                updateStatsUI();
                return;
            }
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                return;
            }
            
            setLogLevel('debug'); // Enable debug logging for Firebase

            // Authenticate user
            let retryCount = 0;
            const maxRetries = 3;

            async function attemptAuth() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) {
                    if (retryCount < maxRetries) {
                        retryCount++;
                        const delay = Math.pow(2, retryCount) * 1000; // Exponential backoff
                        console.warn(`Auth failed, retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return attemptAuth();
                    } else {
                        console.error("Final authentication attempt failed:", e);
                    }
                }
            }
            await attemptAuth();


            onAuthStateChanged(auth, (user) => {
                if (user) {
                    setupStatsListener(user.uid);
                } else {
                    console.log("User authentication incomplete or failed.");
                    document.getElementById('stats-display').innerHTML = '<span class="text-red-400">Stats unavailable (Auth error)</span>';
                }
            });
        }


        // --- Game Logic ---

        const guessInputContainer = document.getElementById('guess-input-container');
        const inputs = Array.from(guessInputContainer.querySelectorAll('input'));
        const guessButton = document.getElementById('guess-button');
        const message = document.getElementById('message');
        const historyList = document.getElementById('history-list');
        
        // Modals
        const resultModal = document.getElementById('result-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCode = document.getElementById('modal-code');
        const modalRestartButton = document.getElementById('modal-restart-button'); 
        const errorModal = document.getElementById('error-modal');
        

        const MAX_GUESSES = 10;
        let secretCode = [];
        let guessCount = 0;

        // --- Utility Functions for Modals ---
        function showModal(isWin) {
            const codeString = secretCode.join('');
            modalCode.textContent = codeString;

            modalTitle.classList.remove('text-green-600', 'text-red-600');
            
            if (isWin) {
                modalTitle.textContent = 'YOU CRACKED IT! ðŸ†';
                modalTitle.classList.add('text-green-600');
                modalMessage.textContent = `Amazing! You guessed the code in ${guessCount} moves.`;
            } else {
                modalTitle.textContent = 'GAME OVER!';
                modalTitle.classList.add('text-red-600');
                modalMessage.textContent = `You ran out of guesses.`;
            }

            resultModal.classList.add('show');
            resultModal.classList.remove('hidden');
        }

        function hideModalAndRestart() {
            resultModal.classList.remove('show');
            // Use setTimeout to ensure the transition finishes before hiding completely
            setTimeout(() => {
                resultModal.classList.add('hidden');
                startGame();
            }, 300);
        }
        
        function showErrorModal(msg) {
            document.getElementById('error-modal-message').textContent = msg; // Set dynamic message
            errorModal.classList.add('show');
            errorModal.classList.remove('hidden');
        }

        function hideErrorModal() {
            errorModal.classList.remove('show');
            setTimeout(() => {
                errorModal.classList.add('hidden');
            }, 300);
            inputs[0].focus(); // Refocus on the first input
        }
        window.hideErrorModal = hideErrorModal; // Expose globally for the button

        // --- Core Logic: Generate Unique 4-Digit Code ---
        function generateSecretCode() {
            const digits = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
            // Shuffle the array
            for (let i = digits.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [digits[i], digits[j]] = [digits[j], digits[i]];
            }
            // Take the first four digits and convert to strings
            return digits.slice(0, 4).map(d => d.toString());
        }

        // --- Core Logic: Check Guess ---
        function checkGuess(guessArr) {
            let bulls = 0;
            let cows = 0;

            for (let i = 0; i < 4; i++) {
                if (guessArr[i] === secretCode[i]) {
                    bulls++;
                } else if (secretCode.includes(guessArr[i])) {
                    cows++;
                }
            }
            return { bulls, cows };
        }

        // --- Game Flow Functions ---
        function startGame() {
            secretCode = generateSecretCode();
            guessCount = 0;
            historyList.innerHTML = '';
            
            // Reset UI
            message.textContent = `Start guessing! (Guess 1 of ${MAX_GUESSES})`;
            message.classList.remove('text-green-600', 'text-red-600');
            message.classList.add('text-gray-700', 'dark:text-gray-300');
            
            inputs.forEach(input => {
                input.value = '';
                input.disabled = false;
            });
            guessButton.disabled = false;
            attemptsCountEl.textContent = MAX_GUESSES;
            inputs[0].focus();
            
            // console.log('Secret Code:', secretCode.join('')); // Keep for testing
        }

        function endGame(isWin) {
            guessButton.disabled = true;
            inputs.forEach(input => input.disabled = true);
            
            // Update persistent stats
            updateWinLossCount(isWin); 
            
            // Show the pop-up
            showModal(isWin); 
        }

        function handleGuess() {
            if (guessButton.disabled) return;
            
            const guessArr = inputs.map(input => input.value.trim());
            const guess = guessArr.join('');

            // Validation 1: Check for 4 digits/empty inputs
            // The isNaN check handles cases where a box might contain a non-digit character if type='text' was used (though filtered by input handler)
            if (guess.length !== 4 || guessArr.some(d => d === '' || isNaN(parseInt(d)))) {
                showErrorModal('You must enter a single digit (0-9) into all four boxes before guessing.');
                return;
            }
            
            // Validation 2: Check for unique digits
            if (new Set(guessArr).size !== 4) {
                 showErrorModal('All four digits must be unique (e.g., 1234, not 1123).');
                 return;
            }

            guessCount++;
            attemptsCountEl.textContent = MAX_GUESSES - guessCount;

            const { bulls, cows } = checkGuess(guessArr);

            // Render result (Keeping user's history style)
            const listItem = document.createElement('li');
            listItem.className = 'flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-3 rounded-xl font-mono shadow-sm';
            
            const bullIcon = `<svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20" title="Bulls"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.84 2.059a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.84-2.059a1 1 0 00-1.175 0l-2.84 2.059c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.01 8.72c-.783-.57-.381-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>`;
            const cowIcon = `<svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20" title="Cows"><circle cx="10" cy="10" r="5" /></svg>`;
            
            listItem.innerHTML = `
                <span class="text-gray-800 dark:text-gray-100 font-bold">${guessCount}. <span class="text-indigo-500">${guess}</span></span>
                <div class="flex items-center space-x-4 font-semibold text-sm sm:text-base">
                    <span class="text-green-500 flex items-center">
                        ${bullIcon}
                        ${bulls} Bulls
                    </span> 
                    <span class="text-orange-400 flex items-center">
                        ${cowIcon}
                        ${cows} Cows
                    </span>
                </div>
            `;
            historyList.prepend(listItem);

            inputs.forEach(input => input.value = ''); // Clear inputs
            inputs[0].focus(); // Focus first input
            
            // --- Check Game End Conditions (FIXED LOGIC) ---

            // 1. Check for Win condition
            if (bulls === 4) {
                message.textContent = `ðŸŽ‰ You Won! The code was ${secretCode.join('')}!`;
                message.classList.remove('text-gray-700', 'dark:text-gray-300', 'text-red-600');
                message.classList.add('text-green-600', 'font-extrabold');
                endGame(true);
                return;
            }

            // 2. Check for Loss condition (Max guesses exceeded)
            if (guessCount >= MAX_GUESSES) {
                message.textContent = `âŒ Game Over! You used ${MAX_GUESSES} guesses.`;
                message.classList.remove('text-gray-700', 'dark:text-gray-300', 'text-green-600');
                message.classList.add('text-red-600', 'font-extrabold');
                endGame(false);
                return;
            }

            // 3. Continue Game
            message.textContent = `Guess #${guessCount + 1} of ${MAX_GUESSES}.`;
            message.classList.remove('text-green-600', 'text-red-600');
            message.classList.add('text-gray-700', 'dark:text-gray-300');
        }
        
        // --- Input Navigation and Event Handlers ---
        function setupInputHandlers() {
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    // Enforce single digit and clean up any non-digit characters
                    e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 1);
                    
                    // Automatically move to next input if a digit is entered
                    if (e.target.value.length === 1 && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                });

                input.addEventListener('keydown', (e) => {
                    // Move back on backspace if input is empty
                    if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
                        e.preventDefault();
                        inputs[index - 1].focus();
                    }
                    // Submit on Enter key press on the last input (Removed redundant submission from here)
                });
            });
        }
        
        // --- Event Listeners to connect the UI to the Logic ---
        guessButton.addEventListener('click', handleGuess);
        modalRestartButton.addEventListener('click', hideModalAndRestart); 

        // Global Enter key listener for convenience (This now reliably calls handleGuess)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !guessButton.disabled && !resultModal.classList.contains('show') && !errorModal.classList.contains('show')) {
                e.preventDefault();
                handleGuess();
            } else if (e.key === 'Escape' && errorModal.classList.contains('show')) {
                hideErrorModal();
            }
        });


        // --- Theme Init ---
        (function(){
            try {
                const saved = localStorage.getItem('theme');
                if (saved === 'dark') document.documentElement.classList.add('dark');
                else if (saved === 'light') document.documentElement.classList.remove('dark');
                else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
            } catch (e) { /* ignore */ }
        })();

        // Initial setup
        window.onload = function() {
            setupInputHandlers();
            startGame();
            initFirebase();
        };

    </script>
</body>
</html>